#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Set Golang dependency
export GOROOT=$(readlink -nf /var/vcap/packages/golang)
export PATH=${GOROOT}/bin:${PATH}
export GOPATH=${BOSH_INSTALL_TARGET}

POSTSTARTHANDLER_PACKAGE_NAME=${BOSH_INSTALL_TARGET}/src/ha-helper/common/poststarthandler
cp -r ${BOSH_COMPILE_TARGET}/ha-helper ${BOSH_INSTALL_TARGET}/
mkdir -p ${BOSH_INSTALL_TARGET}/src
mkdir -p ${BOSH_INSTALL_TARGET}/bin
mv ${BOSH_INSTALL_TARGET}/ha-helper ${BOSH_INSTALL_TARGET}/src/

cd ${POSTSTARTHANDLER_PACKAGE_NAME}
go build

# Moving the binaries
mv ${POSTSTARTHANDLER_PACKAGE_NAME}/poststarthandler ${BOSH_INSTALL_TARGET}/bin
