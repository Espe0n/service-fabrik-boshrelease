#!/bin/bash

set -u # report the usage of uninitialized variables

set +e
# Default actions to be taken before HA setup
sudo rm -f /etc/init/keepalived.conf
sudo rm -rf /etc/keepalived/
sudo service keepalived stop

set -e # exit immediately if a simple command exits with a non-zero status

# Checking if HA setup needs to be done or not.
ha_enabled=<%= p('ha_enabled') %>
if [[ "$ha_enabled" != "true" ]]; then
  exit 0
fi

# Steps for performing HA setup
cp /var/vcap/jobs/service-fabrik-broker/config/keepalived/upstart.conf /etc/init/keepalived.conf

mkdir -p /etc/keepalived

cp /var/vcap/jobs/service-fabrik-broker/config/keepalived/keepalived.conf /etc/keepalived/keepalived.conf

if [ ! -L /etc/keepalived/get_sf_broker_status.sh ]; then
   ln -s /var/vcap/jobs/service-fabrik-broker/config/keepalived/get_sf_broker_status.sh /etc/keepalived/get_sf_broker_status.sh
fi

if [ ! -L /etc/keepalived/notify.sh ]; then
   ln -s /var/vcap/jobs/service-fabrik-broker/config/keepalived/notify.sh /etc/keepalived/notify.sh
fi

if [ ! -L /etc/keepalived/action.sh ]; then
   ln -s /var/vcap/jobs/service-fabrik-broker/config/keepalived/action.sh /etc/keepalived/action.sh
fi

if [ ! -L /etc/keepalived/get_keepalived_state.sh  ]; then
   ln -s /var/vcap/jobs/service-fabrik-broker/config/keepalived/get_keepalived_state.sh /etc/keepalived/get_keepalived_state.sh
fi

chmod +x /etc/keepalived/get_sf_broker_status.sh
chmod +x /etc/keepalived/notify.sh
chmod +x /etc/keepalived/action.sh
chmod +x /etc/keepalived/get_keepalived_state.sh

sudo service keepalived restart
