export PATH=$PATH:/var/vcap/packages/awscli/bin
export SUBNET_ID='<%= spec.networks.sf_service_fabrik_broker.cloud_properties.subnet %>'

BACKUP_OBJ='<%= JSON.dump(p('backup.provider', nil)) %>'
JQ_CMD=/var/vcap/packages/jq/bin/jq

ACCESS_KEY_ID="$(echo "${BACKUP_OBJ}" | "${JQ_CMD}" -r '.keyId')"
SECRET_ACCESS_KEY="$(echo "${BACKUP_OBJ}" | "${JQ_CMD}" -r '.key')"
REGION_NAME="$(echo "${BACKUP_OBJ}" | "${JQ_CMD}" -r '.region')"

aws configure set aws_access_key_id "$ACCESS_KEY_ID"
aws configure set aws_secret_access_key "$SECRET_ACCESS_KEY"
aws configure set region "$REGION_NAME"

network_metadata=$(aws ec2 describe-network-interfaces --filter "Name=private-ip-address,Values=10.11.252.13" | "${JQ_CMD}" -r --arg SUBNET_ID "$SUBNET_ID" '.[][] | select(.SubnetId==$SUBNET_ID)')
export ENI_ID=$(echo "$network_metadata" | "${JQ_CMD}" -r '.NetworkInterfaceId')
aws ec2 assign-private-ip-addresses --network-interface-id $ENI_ID --allow-reassignment --private-ip-addresses 10.11.252.15
sudo ip addr add 10.11.252.15 dev eth0
